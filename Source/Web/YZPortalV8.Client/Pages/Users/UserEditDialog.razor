@using Application.Models;
@using Application.Requests.Users;
﻿@using BootstrapBlazor.Components
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using System.Diagnostics.CodeAnalysis;
@using YZPortalV8.Client.Clients.YZPortalApi
@using GraphModel = Application.Models.Graph;
@using IdentityModel = Application.Models.Identity;

@inject YZPortalApiHttpClient YZPortalApiClient

<Row ItemsPerRow="ItemsPerRow.One">
    <Card CollapseIcon="fas fa-circle-info" HeaderText="Customer Info" IsShadow="true" IsCollapsible="true">
        <BodyTemplate>
            <EditForm Model="@User" OnValidSubmit="OnValidSubmit">
                <div class="col-12">
                    <BootstrapInput @bind-Value="@User.UserName" IsDisabled="true" DisplayText="Email" ShowLabel="true" />
                </div>
                <div class="col-12">
                    <BootstrapInput @bind-Value="@User.DisplayName" DisplayText="Display Name" ShowLabel="true" />
                </div>
                <div class="col-12">
                    <BootstrapInput @bind-Value="@User.FirstName" DisplayText="First Name" ShowLabel="true" />
                </div>
                <div class="col-12">
                    <BootstrapInput @bind-Value="@User.LastName" DisplayText="Last Name" ShowLabel="true" />
                </div>
                <div class="col-12">
                    <BootstrapInput @bind-Value="@User.MobilePhone" DisplayText="MobilePhone" ShowLabel="true" />
                </div>
                <div class="col-12 row g-3">
                    <div class="col-12 col-sm-8">
                        <MultiSelect ShowLabel="true" DisplayText="Roles" Items="@GraphGroups" @bind-Value="SelectedGraphGroups" />
                    </div>
                    <div class="col-12 col-sm-4 align-self-end">
                        <Button Icon="fa-regular fa-trash-can" Text="Clear" OnClick="@ClearListItems" />
                    </div>
                </div>
                <div class="col-12">
                    <div class="uni-translator-button-group">
                        <button type="submit" form="@nameof(UserEditDialog)" class="btn btn-primary">Save</button>
                        @* <Button Text="Cancel" Icon="fa-solid fa-braille" IsAsync="true" OnClick="@CloseDialog" class="me-2"></Button> *@
                    </div>
                </div>
            </EditForm>
        </BodyTemplate>
    </Card>
    <Card CollapseIcon="fas fa-shopping-cart" HeaderText="Orders" IsShadow="true" IsCollapsible="true">
        <BodyTemplate>
        </BodyTemplate>
    </Card>
</Row>

@code {
    private List<SelectedItem> GraphGroups = new List<SelectedItem>();
    private IEnumerable<string?> SelectedGraphGroups { get; set; } = Enumerable.Empty<string?>();
    private IEnumerable<string?> ExistingGraphGroups { get; set; } = Enumerable.Empty<string?>();

    [Parameter]
    public EventCallback<MouseEventArgs> CloseDialog { get; set; }

    [Parameter]
    public IdentityModel.UserModel User { get; set; } = new IdentityModel.UserModel();

    public UpdateUserCommand UpdateUserRequest { get; set; } = new UpdateUserCommand();

    private static List<SelectedItem> GenerateDataSource(List<GraphModel.GroupModel> source) => source.Select(i => new SelectedItem(i.Id, i.DisplayName ?? string.Empty)).ToList();

    private async Task OnValidSubmit()
    {
        var userSubIds = new string[] { User.SubjectIdentifier ?? string.Empty };

        // Add groups
        foreach (var selectedGraphGroup in SelectedGraphGroups.Except(ExistingGraphGroups))
        {
            await YZPortalApiClient.GraphGroupAddUsers(selectedGraphGroup, userSubIds);
        }

        // Remove groups
        foreach (var selectedGraphGroup in ExistingGraphGroups.Except(SelectedGraphGroups))
        {
            await YZPortalApiClient.GraphGroupRemoveUser(selectedGraphGroup, User.SubjectIdentifier);
        }

        await YZPortalApiClient.UpdateUserAsync(User.SubjectIdentifier, new UpdateUserCommand()
        {
            DisplayName = User.DisplayName,
            FirstName = User.FirstName,
            LastName = User.LastName,
            MobilePhone = User.MobilePhone
        });

        await CloseDialog.InvokeAsync();
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        var graphGroups = await YZPortalApiClient.GetGraphGroups();
        this.GraphGroups = GenerateDataSource(graphGroups.Data);

        var selectedGraphGroups = await YZPortalApiClient.GetGraphGroups(User.SubjectIdentifier);
        this.SelectedGraphGroups = ExistingGraphGroups = selectedGraphGroups.Data.Select(x => x.Id).ToList();
    }

    private void ClearListItems()
    {
        SelectedGraphGroups = Enumerable.Empty<string?>();
    }
}