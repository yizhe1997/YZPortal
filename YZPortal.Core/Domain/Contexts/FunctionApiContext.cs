namespace YZPortal.Core.Domain.Contexts
{
    public class FunctionApiContext/* : IFunctionApiContext*/
    {
        //private readonly FunctionApiOptions _options;

        //public FunctionApiContext(IOptions<FunctionApiOptions> options)
        //{
        //    _options = options.Value;
        //}

        //#region DataSets        

        //#region Attachments

        //public FunctionApiSet<DocumentAttachmentUpload> DocumentAttachmentUploads => new FunctionApiSet<DocumentAttachmentUpload>(this);
        //public FunctionApiSet<DocumentAttachmentDetailsDownload> DocumentAttachmentDetailsDownloads => new FunctionApiSet<DocumentAttachmentDetailsDownload>(this);
        //public FunctionApiSet<DocumentAttachmentDelete> DocumentAttachmentDeletes => new FunctionApiSet<DocumentAttachmentDelete>(this);

        //#endregion

        //#region Dealers

        //public FunctionApiSet<DealerAddress> DealerAddresses => new FunctionApiSet<DealerAddress>(this);

        //#endregion

        //#region Parts

        //public FunctionApiSet<PartPrice> PartPrices => new FunctionApiSet<PartPrice>(this);
        //public FunctionApiSet<PartPriceList> PartPriceList => new FunctionApiSet<PartPriceList>(this);
        //public FunctionApiSet<ProductDimension> ProductDimensions => new FunctionApiSet<ProductDimension>(this);
        //public FunctionApiSet<ProcessPartsOrderEnvelope> ProcessPartsOrders => new FunctionApiSet<ProcessPartsOrderEnvelope>(this);
        //public FunctionApiSet<BomItems> BoMItems => new FunctionApiSet<BomItems>(this);
        //public FunctionApiSet<SupplimentaryItem> SupplimentaryItem => new FunctionApiSet<SupplimentaryItem>(this);
        //public FunctionApiSet<ChangedItems> ChangedItems => new FunctionApiSet<ChangedItems>(this);
        //public FunctionApiSet<ValidatePartsReturnQty> ValidatePartsReturnQty => new FunctionApiSet<ValidatePartsReturnQty>(this);
        //public FunctionApiSet<PartsInquiry> PartsInquiries => new FunctionApiSet<PartsInquiry>(this);
        //public FunctionApiSet<SupplierItemInquiry> SupplierItemInquiries => new FunctionApiSet<SupplierItemInquiry>(this);
        //public FunctionApiSet<PartOrderDelete> PartOrderDeletes => new FunctionApiSet<PartOrderDelete>(this);
        //public FunctionApiSet<PartsTransaction> PartsTransactions => new FunctionApiSet<PartsTransaction>(this);

        //#endregion

        //#region Devices

        //public FunctionApiSet<DeviceOrderType> DeviceOrderTypes => new FunctionApiSet<DeviceOrderType>(this);
        //public FunctionApiSet<DeviceConfiguration> DeviceConfigurations => new FunctionApiSet<DeviceConfiguration>(this);
        //public FunctionApiSet<DeviceConfigurationPrice> DeviceConfigurationPrices => new FunctionApiSet<DeviceConfigurationPrice>(this);
        //public FunctionApiSet<Device> Devices => new FunctionApiSet<Device>(this);
        //public FunctionApiSet<DeviceConfigurationCount> DeviceConfigurationCounts => new FunctionApiSet<DeviceConfigurationCount>(this);
        //public FunctionApiSet<ProcessDeviceOrderEnvelope> ProcessDeviceOrders => new FunctionApiSet<ProcessDeviceOrderEnvelope>(this);
        //public FunctionApiSet<DeviceImage> DeviceImages => new FunctionApiSet<DeviceImage>(this);
        //public FunctionApiSet<DeviceClassWithInventory> DeviceClassWithInventory => new FunctionApiSet<DeviceClassWithInventory>(this);
        //public FunctionApiSet<DeviceModelWithInventory> DeviceModelWithInventory => new FunctionApiSet<DeviceModelWithInventory>(this);
        //public FunctionApiSet<DeviceStatus> DeviceStatuses => new FunctionApiSet<DeviceStatus>(this);
        //public FunctionApiSet<DeviceStatusInvoicedRequested> DeviceStatusInvoicedRequests => new FunctionApiSet<DeviceStatusInvoicedRequested>(this);
        //public FunctionApiSet<DeviceStatusInvoiced> DeviceStatusInvoices => new FunctionApiSet<DeviceStatusInvoiced>(this);
        //public FunctionApiSet<DeviceStatusConsignmentAwaiting> DeviceStatusConsignmentAwaitings => new FunctionApiSet<DeviceStatusConsignmentAwaiting>(this);
        //public FunctionApiSet<DeviceOrderDelete> DeviceOrderDeletes => new FunctionApiSet<DeviceOrderDelete>(this);
        //public FunctionApiSet<DocumentStatus> DocumentStatuses => new FunctionApiSet<DocumentStatus>(this);

        //#endregion

        //#region Warranties

        //public FunctionApiSet<LabourMiscCode> LabourMiscCodes => new FunctionApiSet<LabourMiscCode>(this);
        //public FunctionApiSet<PartsMiscCode> PartsMiscCodes => new FunctionApiSet<PartsMiscCode>(this);
        //public FunctionApiSet<WarrantyDeviceIdentification> WarrantyDeviceIdentifications => new FunctionApiSet<WarrantyDeviceIdentification>(this);
        //public FunctionApiSet<ProcessWarrantyClaimEnvelope> ProcessWarrantyClaims => new FunctionApiSet<ProcessWarrantyClaimEnvelope>(this);
        //public FunctionApiSet<WarrantyClaimLabourPriceModel> LabourPrice => new FunctionApiSet<WarrantyClaimLabourPriceModel>(this);
        //public FunctionApiSet<WarrantyMiscCodePrice> MiscCodePrice => new FunctionApiSet<WarrantyMiscCodePrice>(this);
        //public FunctionApiSet<ClaimLinePrice> ClaimLinePrices => new FunctionApiSet<ClaimLinePrice>(this);
        //public FunctionApiSet<WarrantyLaborLineStandardHrs> WarrantyLaborLinesStandardHrs => new FunctionApiSet<WarrantyLaborLineStandardHrs>(this);
        //public FunctionApiSet<WarrantySubmit> SubmitWarranty => new FunctionApiSet<WarrantySubmit>(this);
        //public FunctionApiSet<WarrantyClaimDelete> WarrantyClaimDeletes => new FunctionApiSet<WarrantyClaimDelete>(this);
        //public FunctionApiSet<WarrantyClaimLinesDelete> WarrantyClaimLinesDeletes => new FunctionApiSet<WarrantyClaimLinesDelete>(this);
        //public FunctionApiSet<WarrantyClaimUsageValidate> WarrantyClaimUsageValidates => new FunctionApiSet<WarrantyClaimUsageValidate>(this);
        //public FunctionApiSet<ClaimStatus> ClaimStatuses => new FunctionApiSet<ClaimStatus>(this);


        //#endregion

        //#region Service Campaign        
        //#endregion

        //#region Delivery Report
        //public FunctionApiSet<DeviceMajorStatus> DeviceMajorStatuses => new FunctionApiSet<DeviceMajorStatus>(this);

        //#endregion

        //#region Case

        //public FunctionApiSet<CasePriority> CasePriorities => new FunctionApiSet<CasePriority>(this);
        //public FunctionApiSet<ProcessCaseEnvelope> ProcessCases => new FunctionApiSet<ProcessCaseEnvelope>(this);
        //#endregion

        //#region DeliveryReports

        //public FunctionApiSet<ProcessDeliveryReportEnvelope> ProcessDeliveryReports => new FunctionApiSet<ProcessDeliveryReportEnvelope>(this);

        //#endregion

        //#region ReturnOrders

        //public FunctionApiSet<ProcessReturnOrderEnvelope> ProcessReturnOrder => new FunctionApiSet<ProcessReturnOrderEnvelope>(this);

        //#endregion

        //#region ServicePlans
        //public FunctionApiSet<ScheduleServiceLineUpdate> ScheduleServiceLineUpdates => new FunctionApiSet<ScheduleServiceLineUpdate>(this);
        //public FunctionApiSet<ServicePlanAssign> ServicePlanAssigns => new FunctionApiSet<ServicePlanAssign>(this);

        //#endregion

        //#region Quotations

        //public FunctionApiSet<ProcessSalesQuotationEnvelope> ProcessSalesQuotations => new FunctionApiSet<ProcessSalesQuotationEnvelope>(this);
        //public FunctionApiSet<SalesQuotationDelete> SalesQuotationDeletes => new FunctionApiSet<SalesQuotationDelete>(this);

        //#endregion

        //#endregion

        //#region IFunctionApiContext

        //public List<object> Entities { get; } = new List<object>();

        //public async Task<HttpResponseMessage> Get(string functionPath, string contextToken = null, Dictionary<string, object> queryParams = default, CancellationToken cancellationToken = new CancellationToken())
        //{
        //    #region Header and URL 

        //    contextToken = GetContextToken(contextToken);
        //    var client = new HttpClient();
        //    var headers = client.DefaultRequestHeaders;
        //    headers.Add("Context-Token", contextToken);

        //    var url = GetFunctionUrl(functionPath, queryParams);

        //    #endregion

        //    #region Async task

        //    HttpResponseMessage response = new();

        //    using (var cts = GetCancellationTokenSource(client, cancellationToken))
        //    {
        //        try
        //        {
        //            response = await client.GetAsync(url, cts.Token);
        //        }
        //        catch (TaskCanceledException)
        //        {
        //            throw new RestException(HttpStatusCode.GatewayTimeout, $"{functionPath} service timedout. Please try again later or contact admin if the issue persists.");
        //        }

        //        if (response.IsSuccessStatusCode)
        //        {
        //            return response;
        //        }
        //        else
        //        {
        //            if (response.StatusCode == HttpStatusCode.Conflict)
        //            {
        //                return response;
        //            }
        //            else if (response.StatusCode == HttpStatusCode.NotAcceptable)
        //            {
        //                return response;
        //            }
        //            else
        //            {
        //                var content = await response.Content.ReadAsStringAsync(cts.Token);
        //                throw new FunctionApiException(HttpStatusCode.UnprocessableEntity, $"Error with {functionPath} service", content);
        //            }

        //        }
        //    }

        //    #endregion
        //}

        //public async Task<HttpResponseMessage> Post(string functionPath, string contextToken = null, Dictionary<string, object> queryParams = default, object body = null, CancellationToken cancellationToken = new CancellationToken())
        //{
        //    #region Header, Body, and URL

        //    contextToken = GetContextToken(contextToken);
        //    var client = new HttpClient();
        //    var headers = client.DefaultRequestHeaders;
        //    headers.Add("Context-Token", contextToken);

        //    var dataAsString = JsonConvert.SerializeObject(body) ?? "{}";
        //    var content = new StringContent(dataAsString);
        //    content.Headers.ContentType = new MediaTypeHeaderValue("application/json");

        //    var url = GetFunctionUrl(functionPath, queryParams);

        //    #endregion

        //    #region Async task

        //    HttpResponseMessage response = new();

        //    using (var cts = GetCancellationTokenSource(client, cancellationToken))
        //    {
        //        try
        //        {
        //            response = await client.PostAsync(url, content, cts.Token);
        //        }
        //        catch (TaskCanceledException)
        //        {
        //            throw new RestException(HttpStatusCode.GatewayTimeout, $"{functionPath} service timedout. Please try again later or contact admin if the issue persists.");
        //        }

        //        if (response.IsSuccessStatusCode)
        //        {
        //            return response;
        //        }
        //        else if (response.StatusCode == HttpStatusCode.Conflict)
        //        {
        //            return response;
        //        }
        //        else
        //        {
        //            var contentError = await response.Content.ReadAsStringAsync(cts.Token);
        //            try
        //            {
        //                var isSerializable = TryParseJSON(contentError, out JObject json);
        //                //JObject json = JObject.Parse(contentError);

        //                if (isSerializable)
        //                    contentError = json.SelectToken("data.errorMessage")?.ToString() ?? contentError;
        //            }
        //            catch (Exception)
        //            {

        //            }

        //            throw new FunctionApiException(HttpStatusCode.UnprocessableEntity, $"Error with {functionPath} service", contentError);
        //        }
        //    }

        //    #endregion
        //}

        //public async Task<List<object>> SaveChangesAsync(string contextToken = null, CancellationToken cancellationToken = new CancellationToken())
        //{
        //    List<object> results = new List<object>();

        //    foreach (var fnEntity in Entities)
        //    {
        //        if (cancellationToken.IsCancellationRequested) break;

        //        // Get FnMapping Attribute to determine function path and name
        //        var fnMapping = fnEntity.GetType().GetCustomAttribute<FunctionApiCreateAttribute>();

        //        // Throw an exception if the GetAll attribute is not set on entity
        //        if (fnMapping == null) throw new NotImplementedException($"The entity {nameof(fnEntity)} does not define the FnGetAll attribute");

        //        // Function name and function path
        //        var fnPath = fnMapping.Path;
        //        var fnResultType = fnMapping.ResultType;

        //        // Create JSON body from object
        //        var body = JObject.FromObject(fnEntity);
        //        var result = await Post(fnPath, contextToken, body: body, cancellationToken: cancellationToken);

        //        var jsonObj = JObject.Parse(await result.Content.ReadAsStringAsync());

        //        // Parse the result according to specified result type
        //        if (fnResultType != null)
        //        {
        //            var entity = jsonObj.ToObject(fnResultType);
        //            results.Add(entity);
        //        }
        //    }

        //    return results;
        //}

        //public async Task<HttpResponseMessage> GetWithBody(string functionPath, string contextToken = null, Dictionary<string, object> queryParams = default, object body = null, CancellationToken cancellationToken = new CancellationToken())
        //{
        //    #region Header, Body, and URL

        //    contextToken = GetContextToken(contextToken);
        //    var client = new HttpClient();
        //    var headers = client.DefaultRequestHeaders;
        //    headers.Add("Context-Token", contextToken);

        //    var dataAsString = JsonConvert.SerializeObject(body) ?? "{}";
        //    var content1 = new StringContent(dataAsString);
        //    content1.Headers.ContentType = new MediaTypeHeaderValue("application/json");

        //    var url = GetFunctionUrl(functionPath, queryParams);

        //    HttpRequestMessage request = new HttpRequestMessage
        //    {
        //        Method = HttpMethod.Get,
        //        RequestUri = new System.Uri(url),
        //        Content = content1
        //    };

        //    #endregion

        //    #region Async task

        //    HttpResponseMessage response = new();

        //    using (var cts = GetCancellationTokenSource(client, cancellationToken))
        //    {
        //        try
        //        {
        //            response = await client.SendAsync(request, cancellationToken);
        //        }
        //        catch (TaskCanceledException)
        //        {
        //            throw new RestException(HttpStatusCode.GatewayTimeout, $"{functionPath} service timedout. Please try again later or contact admin if the issue persists.");
        //        }

        //        if (response.IsSuccessStatusCode)
        //        {
        //            return response;
        //        }
        //        else
        //        {
        //            var content = await response.Content.ReadAsStringAsync();
        //            throw new FunctionApiException(HttpStatusCode.UnprocessableEntity, $"Error with {functionPath} service", content);
        //        }
        //    }

        //    #endregion
        //}

        //#endregion

        //#region  Helpers

        //private static bool TryParseJSON(string json, out JObject jObject)
        //{
        //    try
        //    {
        //        jObject = JObject.Parse(json);
        //        return true;
        //    }
        //    catch
        //    {
        //        jObject = null;
        //        return false;
        //    }
        //}

        //public string GetContextToken(string contextToken, CancellationToken cancellationToken = new CancellationToken())
        //{
        //    // Get admin context token if contextToken is empty or null
        //    if (string.IsNullOrEmpty(contextToken))
        //    {
        //        var client = new HttpClient();

        //        var url = new Url($"{_options.ApiUrl}/api/getAdmin");

        //        url.QueryParams.Add("code", _options.ApiKey);

        //        var response = client.GetAsync(url.ToString(), cancellationToken).Result;

        //        if (response.StatusCode != HttpStatusCode.OK)
        //        {
        //            dynamic content = response.Content.ReadAsStringAsync().Result;
        //            dynamic objt = JsonConvert.DeserializeObject(content);
        //            throw new FunctionApiException(HttpStatusCode.UnprocessableEntity, "Error with getAdmin service", objt.message);
        //        }

        //        var ret = response.Content.ReadAsStringAsync().Result;

        //        dynamic obj = JsonConvert.DeserializeObject(ret);

        //        string token = obj.data?.contextToken;

        //        return IsContextTokenEmptyGuid(token, true);
        //    }
        //    // Return contextToken if not empty guid
        //    return IsContextTokenEmptyGuid(contextToken, false);
        //}

        ///// <summary>
        /////     Checks if token is empty guid. The presence of "*" indicates whether the error came from
        /////     fno or backend.
        ///// </summary>
        //public string IsContextTokenEmptyGuid(string contextToken, bool isFromFno) => contextToken == Guid.Empty.ToString() ?
        //    throw new RestException(HttpStatusCode.InternalServerError, (isFromFno ? "*" : "") + "Missing user in Annata D365. Please contact your System Administrator") :
        //    contextToken;

        //private string GetFunctionUrl(string functionPath, Dictionary<string, object> queryParams = default)
        //{
        //    var url = new Url($"{_options.ApiUrl}/api/{functionPath}");

        //    url.QueryParams.Add("code", _options.ApiKey);

        //    if (queryParams != null)
        //    {
        //        Parallel.ForEach(queryParams, param =>
        //        {
        //            url.QueryParams.Add(param.Key, param.Value);
        //        });

        //        // Add global language support
        //        queryParams.Add("lang", _options.Language);
        //    }

        //    return url.ToString();
        //}

        ///// <summary>
        /////     Creates token source to manipulate timeout threshold - useful if customer wants to increase or decrease it
        ///// </summary>
        //private CancellationTokenSource GetCancellationTokenSource(HttpClient request, CancellationToken cancellationToken)
        //{
        //    var timeout = TimeSpan.FromSeconds(_options.TimeoutSeconds);

        //    var cts = CancellationTokenSource.CreateLinkedTokenSource(cancellationToken);
        //    cts.CancelAfter(timeout);
        //    return cts;
        //}

        //#endregion
    }
}
